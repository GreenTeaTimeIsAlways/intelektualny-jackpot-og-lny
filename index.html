<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelektualny Jackpot - Discord Live üî¥</title>
    <style>
        /* Stylistyka Kasyna - Vegas Theme */
        body {
            background-color: #0a1a12;
            color: #ffd700;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-image: radial-gradient(circle at center, #1a4a30 0%, #08140e 100%);
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .casino-container {
            text-align: center;
            background: #111;
            padding: 30px 40px;
            border-radius: 15px;
            border: 3px solid #ffd700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(0,0,0,0.8);
            max-width: 800px;
            width: 100%;
        }

        h1 { margin-top: 0; text-transform: uppercase; letter-spacing: 2px; font-size: 28px; text-shadow: 0 0 10px #ffd700, 0 0 20px #d4af37; }
        .live-badge { display: inline-block; background: #ff0000; color: #fff; font-size: 12px; padding: 2px 8px; border-radius: 10px; vertical-align: middle; margin-left: 10px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- NOWA MASZYNA LOSUJƒÑCA (SLOT) --- */
        .slot-machine-wrapper {
            background: linear-gradient(145deg, #2a2a2a, #111);
            padding: 15px;
            border-radius: 15px;
            border: 4px solid #8b6508;
            box-shadow: 0 10px 20px rgba(0,0,0,0.6), inset 0 0 15px rgba(255, 215, 0, 0.1);
            margin: 25px 0;
            position: relative;
        }
        .slot-machine-view {
            height: 100px;
            background: #000411; /* Ciemnogranatowy ekran maszyny */
            border: 3px solid #00f3ff; /* Neonowa ramka */
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 25px #000;
        }
        .slot-machine-view::before, .slot-machine-view::after {
            content: ""; position: absolute; left: 0; width: 100%; height: 25px; z-index: 2;
        }
        .slot-machine-view::before { top: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
        .slot-machine-view::after { bottom: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .slot-marker {
            position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
            background: rgba(255, 0, 0, 0.7); transform: translateY(-50%); z-index: 3; box-shadow: 0 0 10px red;
        }
        .reel { position: absolute; top: 0; left: 0; width: 100%; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); }
        .reel-item { 
            height: 100px; line-height: 100px; font-size: 26px; font-weight: bold; 
            color: #00f3ff; text-transform: uppercase; text-shadow: 0 0 10px #00f3ff; 
        }

        /* --- UK≈ÅAD POZIOMY (TRYBY GRY) --- */
        .settings-panel { 
            background: rgba(0, 0, 0, 0.6); padding: 15px; border-radius: 10px; 
            border: 2px solid #d4af37; margin-bottom: 25px; 
            display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;
        }
        .radio-group { display: flex; align-items: center; gap: 20px; }
        .radio-group label { cursor: pointer; font-size: 18px; color: #fff; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .radio-group input[type="radio"] { width: 18px; height: 18px; cursor: pointer; margin: 0; }
        #deathmatchSettings { display: flex; align-items: center; gap: 5px; }

        /* Przycisk D≈∫wiƒôku w rogu */
        #audioUnlockBtn {
            position: fixed; top: 15px; right: 15px; background: #ff4500; color: white; border: none; 
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; z-index: 1000; 
            box-shadow: 0 0 15px rgba(255, 69, 0, 0.6); font-size: 14px;
        }

        /* Pozosta≈Çe elementy (Oryginalne) */
        #loginOverlay { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 60vh; }
        .discord-btn { background-color: #5865F2; color: white; padding: 15px 30px; font-size: 18px; font-weight: bold; text-decoration: none; border-radius: 8px; display: inline-flex; align-items: center; gap: 10px; transition: background 0.3s; margin-top: 20px; border: none; cursor: pointer; }
        .discord-btn:hover { background-color: #4752C4; }
        .user-profile { display: flex; align-items: center; justify-content: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-bottom: 20px; border: 1px dashed #5865F2; }
        .panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        @media (max-width: 600px) { .panel-grid { grid-template-columns: 1fr; } }
        .panel { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; border: 1px solid #555; text-align: left; }
        .panel h3 { margin-top: 0; color: #ccc; font-size: 16px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #ffd700; background: #222; color: white; border-radius: 5px; box-sizing: border-box; outline: none; }
        button.action-btn { width: 100%; padding: 8px; background: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        button.action-btn:hover { background: #218838; }
        button.action-btn:disabled { background: #555; color: #888; cursor: not-allowed; }
        button.clear-btn { background: #dc3545; margin-top: 5px; }
        button.clear-btn:hover { background: #c82333; }
        button.kick-btn { background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; padding: 2px 8px; font-size: 10px; float: right; margin-left: 5px; }
        button.unban-btn { background: #28a745; color: white; border: none; padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 11px; float: right; }
        .admin-bank-panel { border-color: #007bff; background: rgba(0, 123, 255, 0.05); }
        .admin-bank-panel h3 { border-bottom-color: #007bff; color: #5bc0de; }
        .btn-blue { background: #007bff; }
        .btn-blue:hover { background: #0056b3; }
        .spin-btn { padding: 15px 40px; font-size: 24px; font-weight: bold; cursor: pointer; background: linear-gradient(to bottom, #ffdf00, #d4af37); color: #000; border: none; border-radius: 50px; text-transform: uppercase; transition: all 0.3s ease; width: 100%; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
        .spin-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6); }
        .spin-btn:disabled { background: #555; color: #888; cursor: not-allowed; }
        #result { padding: 20px; border: 2px dashed #ffd700; background: rgba(255, 215, 0, 0.05); border-radius: 10px; min-height: 100px; margin-bottom: 20px; }
        .hidden { display: none !important; }
        .result-title { font-size: 16px; color: #ccc; margin: 0 0 10px 0; }
        .result-players { font-size: 24px; font-weight: bold; color: #fff; text-shadow: 0 0 10px #fff; margin-bottom: 15px; }
        .result-topic { font-size: 20px; color: #4CAF50; font-style: italic; background: #000; padding: 10px; border-radius: 5px;}
        .stats-info { font-size: 12px; color: #888; margin-top: 5px; margin-bottom: 10px; }
        .history-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; text-align: left; }
        .history-list li { background: #222; margin-bottom: 8px; padding: 10px; border-radius: 5px; border-left: 3px solid #ffd700; font-size: 14px; color: #ddd; }
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }
        body.preview-player-mode .admin-only { display: none !important; }
        .view-toggle-btn { background: #555; color: #eee; border: 1px solid #777; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-bottom: 20px; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>
</head>
<body>

    <audio id="spinSnd" src="https://actions.google.com/sounds/v1/science_fiction/pulsating_hum.ogg" preload="auto"></audio>
    <audio id="winSnd" src="https://actions.google.com/sounds/v1/human/applause_and_cheering.ogg" preload="auto"></audio>

    <button id="audioUnlockBtn" onclick="unlockAudio()">üîä W≈ÅƒÑCZ D≈πWIƒòK</button>

    <div class="casino-container">
        <h1>üé∞ Intelektualny Jackpot <span class="live-badge">LIVE</span></h1>

        <div id="loginOverlay">
            <h2 style="color: #ccc;">Dostƒôp tylko dla zweryfikowanych graczy</h2>
            <p style="color: #888; font-size: 14px;">Zaloguj siƒô, aby zsynchronizowaƒá sw√≥j nick z maszynƒÖ losujƒÖcƒÖ.</p>
            <button id="discordLoginBtn" class="discord-btn">
                <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a6a49cf127bf92de1e2_icon_clyde_blurple_RGB.png" alt="Discord" style="width: 24px;">
                Zaloguj przez Discord
            </button>
        </div>

        <div id="mainApp" class="hidden">
            <div class="user-profile">
                <span style="color:#aaa;">Zalogowano jako:</span>
                <span id="discordUsernameDisplay" style="color:#5865F2; font-weight:bold; font-size:18px;">...</span>
                <span class="admin-only" style="margin-left: 10px; background: #dc3545; color: white; padding: 2px 6px; border-radius: 5px; font-size: 12px; font-weight: bold;">HOST</span>
            </div>

            <button class="admin-only view-toggle-btn" onclick="toggleViewMode()">üëÅÔ∏è Prze≈ÇƒÖcz widok (Host/Gracz)</button>

            <div class="slot-machine-wrapper">
                <div class="slot-machine-view">
                    <div class="slot-marker"></div>
                    <div id="reel" class="reel">
                        <div class="reel-item">OCZEKIWANIE...</div>
                    </div>
                </div>
            </div>

            <div class="settings-panel">
                <div class="radio-group">
                    <label><input type="radio" name="gameMode" value="versus" checked onchange="toggleMode()"> ‚öîÔ∏è Versus</label>
                    <label><input type="radio" name="gameMode" value="deathmatch" onchange="toggleMode()"> üíÄ DM</label>
                </div>
                <div id="deathmatchSettings" class="hidden">
                    <label style="color:#fff; font-weight:bold;">Ilo≈õƒá:</label>
                    <input type="number" id="drawCount" min="3" max="20" value="3" style="width: 60px; text-align:center; margin-bottom: 0;">
                </div>
            </div>
            
            <button id="spinBtn" class="spin-btn" onclick="drawJackpot()">LOSUJ!</button>
            
            <div id="result" class="hidden">
                <p class="result-title">Wylosowani Uczestnicy:</p>
                <div id="winnerNames" class="result-players"></div>
                <p class="result-title">Temat starcia:</p>
                <div id="winnerTopic" class="result-topic"></div>
            </div>

            <div class="panel-grid">
                <div class="panel">
                    <h3>üë• Baza Graczy</h3>
                    <button id="joinPoolBtn" class="action-btn" onclick="joinGame()">üéÆ Do≈ÇƒÖcz do losowania</button>
                    <button class="action-btn clear-btn admin-only" onclick="clearPlayers()">üóëÔ∏è Wyczy≈õƒá wszystkich</button>
                    <h4 style="margin: 15px 0 5px 0; color: #aaa; font-size: 14px; border-bottom: 1px dashed #444;">Lista obecnych: (<span id="playerCountDisplay">0</span>)</h4>
                    <ul class="history-list" id="activePlayersList" style="max-height: 120px;"></ul>
                </div>

                <div class="panel">
                    <h3>üí° Dorzuƒá Temat (Max 5/os.)</h3>
                    <input type="text" id="newTopic" placeholder="Wpisz temat na tƒô rundƒô">
                    <button class="action-btn" onclick="addTopic()">Dodaj do Puli jako Ty</button>
                    <div class="stats-info">Temat√≥w w obecnej puli: <span id="topicCountDisplay">0</span></div>
                    <button class="action-btn clear-btn admin-only" onclick="clearTopics()">üóëÔ∏è Wyczy≈õƒá obecnƒÖ pulƒô</button>
                </div>
            </div>

            <div class="panel admin-only admin-bank-panel" style="margin-bottom: 25px;">
                <h3>üè¶ Skarbiec Temat√≥w (Admin)</h3>
                <select id="adminTopicSelect">
                    <option value="">-- Wybierz temat ze skarbca --</option>
                </select>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="action-btn btn-blue" onclick="pushBankTopic()">‚ûï U≈ºyj tego tematu</button>
                    <button class="action-btn clear-btn" onclick="deleteBankTopic()" style="margin-top:0;">üóëÔ∏è Usu≈Ñ z banku</button>
                </div>
                <div style="margin-top: 15px; border-top: 1px dashed #444; padding-top: 10px;">
                    <input type="text" id="adminNewTopic" placeholder="Wpisz temat prosto do banku...">
                    <button class="action-btn btn-blue" onclick="createBankTopic()">Zapisz w banku</button>
                </div>
            </div>

            <div class="panel admin-only" style="margin-bottom: 25px; border-color: #dc3545;">
                <h3>üõë Skarbiec Ban√≥w (Admin)</h3>
                <ul class="history-list" id="banListUI" style="max-height: 100px;"></ul>
            </div>

            <div class="panel">
                <h3>üìú Historia Losowa≈Ñ (Live)</h3>
                <ul class="history-list" id="historyList"></ul>
            </div>
        </div>
    </div>

    <script>
        // Funkcja D≈∫wiƒôkowa (Odblokowanie)
        function unlockAudio() {
            const spin = document.getElementById('spinSnd');
            const win = document.getElementById('winSnd');
            spin.play().then(() => spin.pause()).catch(() => {});
            win.play().then(() => win.pause()).catch(() => {});
            document.getElementById('audioUnlockBtn').style.display = 'none';
        }

        // --- KONFIGURACJA ---
        const ADMIN_DISCORD_ID = "TUTAJ_WKLEJ_SWOJE_ID_DISCORD"; 
        const CLIENT_ID = "1477107560988414067";
        const REDIRECT_URI = "https://greenteatimeisalways.github.io/intelektualny-jackpot-og-lny/";
        const discordAuthUrl = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;

        const firebaseConfig = {
            apiKey: "AIzaSyBu8MIxIAAYwYnDEofUE4mZep7cor5MlFM",
            authDomain: "intelektualny-jackpot.firebaseapp.com",
            databaseURL: "https://intelektualny-jackpot-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "intelektualny-jackpot",
            storageBucket: "intelektualny-jackpot.firebasestorage.app",
            messagingSenderId: "938726974898",
            appId: "1:938726974898:web:0f99b1384efc952c9eb0ab"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentDiscordUser = null;
        let currentDiscordID = null;
        let isAdmin = false;
        let playersData = [], players = [], topics = [], bankTopicsData = [], history = [], bannedList = {};

        document.getElementById('discordLoginBtn').addEventListener('click', () => {
            window.location.href = discordAuthUrl;
        });

        window.onload = () => {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const accessToken = fragment.get('access_token');
            if (accessToken) {
                fetch('https://discord.com/api/users/@me', {
                    headers: { authorization: `Bearer ${accessToken}` }
                })
                .then(res => res.json())
                .then(user => {
                    currentDiscordUser = user.global_name || user.username;
                    currentDiscordID = user.id;
                    if (currentDiscordID === ADMIN_DISCORD_ID) {
                        isAdmin = true;
                        document.body.classList.add("is-admin");
                    }
                    document.getElementById('loginOverlay').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('discordUsernameDisplay').innerText = currentDiscordUser;
                    initFirebaseListeners();
                });
            }
        };

        function toggleViewMode() { document.body.classList.toggle('preview-player-mode'); }

        function initFirebaseListeners() {
            db.ref('discord_players').on('value', snap => {
                playersData = []; players = [];
                snap.forEach(c => { 
                    playersData.push({key: c.key, name: c.val().name, id: c.val().id});
                    players.push(c.val().name);
                });
                updateUI();
            });
            db.ref('discord_topics').on('value', snap => {
                topics = []; snap.forEach(c => topics.push(c.val()));
                updateUI();
            });
            db.ref('discord_adminBank').on('value', snap => {
                bankTopicsData = []; snap.forEach(c => bankTopicsData.push({key: c.key, ...c.val()}));
                if(isAdmin) updateAdminBankUI();
            });
            db.ref('discord_history').on('value', snap => {
                history = []; snap.forEach(c => history.push(c.val()));
                history.reverse(); updateUI();
            });
            db.ref('discord_bans').on('value', snap => {
                bannedList = snap.val() || {};
                updateBanUI();
            });
        }

        function joinGame() {
            if (bannedList[currentDiscordID]) return alert("Zbanowany!");
            if (players.includes(currentDiscordUser)) return alert("Ju≈º jeste≈õ!");
            db.ref('discord_players').push({ name: currentDiscordUser, id: currentDiscordID });
        }

        function banPlayer(key, id, name) {
            if(confirm(`Ban ${name}?`)) {
                db.ref('discord_bans/' + id).set(name);
                db.ref('discord_players/' + key).remove();
            }
        }

        function addTopic() {
            const txt = document.getElementById('newTopic').value.trim();
            if(!txt) return;
            const myTopics = topics.filter(t => t.author === currentDiscordUser);
            if(myTopics.length >= 5) return alert("Limit!");
            db.ref('discord_topics').push({author: currentDiscordUser, text: txt});
            db.ref('discord_adminBank').push({author: currentDiscordUser, text: txt});
            document.getElementById('newTopic').value = "";
        }

        // ZMODYFIKOWANA FUNKCJA LOSOWANIA (Z animacjƒÖ z maszyny i d≈∫wiƒôkiem)
        function drawJackpot() {
            const mode = document.querySelector('input[name="gameMode"]:checked').value;
            const count = mode === 'versus' ? 2 : parseInt(document.getElementById('drawCount').value);
            if(players.length < count || topics.length === 0) return alert("Braki w graczach lub tematach!");
            
            const btn = document.getElementById('spinBtn');
            const reel = document.getElementById('reel');
            const s1 = document.getElementById('spinSnd');
            const s2 = document.getElementById('winSnd');
            
            btn.disabled = true;
            document.getElementById('result').classList.add('hidden'); // Ukrywamy stary wynik na czas losowania

            // Obliczamy wygranƒÖ
            const winPlayersArr = shuffleArray([...players]).slice(0, count);
            const winPlayersStr = winPlayersArr.join(" VS ");
            const winTopic = topics[Math.floor(Math.random() * topics.length)];

            // Budujemy bƒôben wizualny
            let reelHtml = "";
            for(let i=0; i<30; i++) {
                reelHtml += `<div class="reel-item">${players[Math.floor(Math.random()*players.length)]}</div>`;
            }
            reelHtml += `<div class="reel-item" style="color:#ffd700;">üèÜ ${winPlayersStr} üèÜ</div>`;
            reel.innerHTML = reelHtml;

            // Start animacji i d≈∫wiƒôku
            reel.style.transition = "none"; 
            reel.style.transform = "translateY(0)";
            
            setTimeout(() => {
                reel.style.transition = "transform 4s cubic-bezier(0.1, 0, 0.1, 1)";
                reel.style.transform = `translateY(-${30 * 100}px)`; // Przesuniƒôcie o 30 blok√≥w (ka≈ºdy ma 100px)
                
                s1.loop = true; 
                s1.play().catch(() => {});

                // Koniec animacji (po 4 sekundach)
                setTimeout(() => {
                    s1.pause(); 
                    s1.currentTime = 0; 
                    s2.play().catch(() => {});
                    
                    // Pokazujemy tekstowy wynik pod maszynƒÖ
                    document.getElementById('result').classList.remove('hidden');
                    document.getElementById('winnerNames').innerText = "üèÜ " + winPlayersStr + " üèÜ";
                    document.getElementById('winnerTopic').innerText = `"${winTopic.text}" (${winTopic.author})`;
                    
                    // Oryginalny zapis do historii bazy
                    saveToHistory(winPlayersStr, winTopic.text, winTopic.author, mode);
                    db.ref('discord_topics').remove();
                    btn.disabled = false;
                }, 4100);
            }, 50);
        }

        function shuffleArray(a) { return a.sort(() => Math.random() - 0.5); }
        function saveToHistory(p, t, a, m) {
            db.ref('discord_history').push({time: new Date().toLocaleTimeString('pl-PL'), players: p, topic: t, author: a, mode: m});
        }
        function toggleMode() {
            document.getElementById('deathmatchSettings').classList.toggle('hidden', document.querySelector('input[name="gameMode"]:checked').value === 'versus');
        }

        function updateAdminBankUI() {
            const s = document.getElementById('adminTopicSelect');
            s.innerHTML = '<option value="">-- Bank temat√≥w --</option>' + bankTopicsData.map(t => `<option value="${t.key}">${t.text}</option>`).join("");
        }
        function updateBanUI() {
            document.getElementById('banListUI').innerHTML = Object.keys(bannedList).map(id => `<li>üõë ${bannedList[id]} <button class="unban-btn" onclick="db.ref('discord_bans/${id}').remove()">Odbanuj</button></li>`).join("");
        }
        function updateUI() {
            document.getElementById('playerCountDisplay').innerText = players.length;
            document.getElementById('topicCountDisplay').innerText = topics.length;
            document.getElementById('activePlayersList').innerHTML = playersData.map(p => `<li>üë§ ${p.name} ${isAdmin ? `<button class="kick-btn" onclick="banPlayer('${p.key}','${p.id}','${p.name}')">BAN</button>` : ''}</li>`).join("");
            document.getElementById('historyList').innerHTML = history.slice(0,20).map(h => `<li>[${h.time}] <b>${h.players}</b>: ${h.topic}</li>`).join("");
            document.getElementById('joinPoolBtn').disabled = players.includes(currentDiscordUser);
        }

        window.createBankTopic = () => {
            const t = document.getElementById('adminNewTopic').value.trim();
            if(t) db.ref('discord_adminBank').push({author: "ADMIN", text: t});
            document.getElementById('adminNewTopic').value = "";
        };
        window.pushBankTopic = () => {
            const k = document.getElementById('adminTopicSelect').value;
            if(k) db.ref('discord_topics').push({author: "ADMIN", text: bankTopicsData.find(x => x.key === k).text});
        };
        window.deleteBankTopic = () => {
            const k = document.getElementById('adminTopicSelect').value;
            if(k) db.ref('discord_adminBank/' + k).remove();
        };
        window.clearPlayers = () => { if(confirm("Wyczy≈õciƒá?")) db.ref('discord_players').remove(); };
        window.clearTopics = () => { if(confirm("Wyczy≈õciƒá?")) db.ref('discord_topics').remove(); };
    </script>
</body>
</html>
