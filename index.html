<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackpot - Debug Mode üé∞</title>
    <style>
        body { background-color: #0f2b1c; color: #ffd700; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .casino-container { text-align: center; background: #111; padding: 20px; border: 3px solid #ffd700; border-radius: 15px; width: 100%; max-width: 600px; }
        .hidden { display: none !important; }
        .btn { background: #5865F2; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        #debug-log { background: #000; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; width: 100%; height: 100px; overflow-y: auto; margin-top: 20px; border: 1px solid #333; text-align: left; }
        .settings-row { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .slot-view { height: 80px; background: #000; border: 2px solid #d4af37; margin: 10px 0; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>
</head>
<body>

<div class="casino-container">
    <h1>üé∞ Jackpot Vegas</h1>
    
    <div id="login-screen">
        <p id="status-text">Inicjalizacja systemu...</p>
        <button id="login-btn" class="btn hidden">ZALOGUJ PRZEZ DISCORD</button>
    </div>

    <div id="app-screen" class="hidden">
        <p>Witaj, <span id="user-name">...</span>!</p>
        <div class="slot-view" id="reel">ZESTAW MASZYNƒò</div>
        
        <div class="settings-row">
            <label><input type="radio" name="mode" value="versus" checked> ‚öîÔ∏è Versus</label>
            <label><input type="radio" name="mode" value="dm"> üíÄ DM</label>
        </div>

        <button class="btn" style="background:#ffd700; color:#000; width:100%;" onclick="draw()">LOSUJ!</button>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <div style="flex:1; background:rgba(255,255,255,0.1); padding:10px; border-radius:5px;">
                Gracze: <span id="p-count">0</span>
                <button class="btn" style="width:100%; font-size:12px;" onclick="join()">DO≈ÅƒÑCZ</button>
            </div>
            <div style="flex:1; background:rgba(255,255,255,0.1); padding:10px; border-radius:5px;">
                Tematy: <span id="t-count">0</span>
                <input type="text" id="t-input" placeholder="Temat..." style="width:80%; margin-top:5px;">
                <button class="btn" style="width:100%; font-size:12px;" onclick="addT()">DODAJ</button>
            </div>
        </div>
    </div>
</div>

<div id="debug-log">SYSTEM LOG: Czekam na start...</div>

<script>
    const debug = (msg) => {
        const log = document.getElementById('debug-log');
        log.innerHTML += `<br>> ${msg}`;
        log.scrollTop = log.scrollHeight;
        console.log(msg);
    };

    const CLIENT_ID = "1477107560988414067";
    const REDIRECT = window.location.origin + window.location.pathname;

    try {
        firebase.initializeApp({
            apiKey: "AIzaSyBu8MIxIAAYwYnDEofUE4mZep7cor5MlFM",
            databaseURL: "https://intelektualny-jackpot-default-rtdb.europe-west1.firebasedatabase.app"
        });
        debug("Firebase: Zainicjowano.");
    } catch(e) { debug("Firebase ERROR: " + e.message); }

    const db = firebase.database();
    let user = null;

    window.onload = () => {
        debug("Okno za≈Çadowane. Sprawdzam token...");
        const hash = new URLSearchParams(window.location.hash.slice(1));
        const token = hash.get('access_token');

        if (token) {
            debug("Token znaleziony! Pobieram dane u≈ºytkownika...");
            fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${token}` } })
            .then(r => r.json())
            .then(data => {
                if(data.id) {
                    user = data;
                    debug(`Zalogowano jako: ${user.username}`);
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                    document.getElementById('user-name').innerText = user.global_name || user.username;
                    startSync();
                } else { debug("B≈ÇƒÖd Discord: Brak ID u≈ºytkownika."); showLogin(); }
            })
            .catch(e => { debug("B≈ÇƒÖd Fetch: " + e.message); showLogin(); });
        } else {
            debug("Brak tokenu. Czekam na logowanie.");
            showLogin();
        }
    };

    function showLogin() {
        document.getElementById('status-text').innerText = "Wymagana autoryzacja.";
        const btn = document.getElementById('login-btn');
        btn.classList.remove('hidden');
        btn.onclick = () => {
            debug("Pr√≥ba przekierowania do Discorda...");
            const url = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT)}&response_type=token&scope=identify`;
            window.location.href = url;
        };
    }

    function startSync() {
        debug("≈ÅƒÖczenie z bazƒÖ danych...");
        db.ref('discord_players').on('value', s => {
            const count = s.numChildren();
            document.getElementById('p-count').innerText = count;
            debug(`Zaktualizowano graczy: ${count}`);
        }, e => debug("Firebase DB Error (players): " + e.message));

        db.ref('discord_topics').on('value', s => {
            document.getElementById('t-count').innerText = s.numChildren();
        }, e => debug("Firebase DB Error (topics): " + e.message));
    }

    function join() { db.ref('discord_players').push({name: user.username, id: user.id}).then(()=>debug("Do≈ÇƒÖczono!")).catch(e=>debug("Join error: "+e.message)); }
    function addT() { 
        const val = document.getElementById('t-input').value;
        if(val) db.ref('discord_topics').push({author: user.username, text: val}).then(()=>debug("Dodano temat!")).catch(e=>debug("Topic error: "+e.message));
    }
    function draw() { debug("Rozpoczynam losowanie..."); /* ... mechanika losowania ... */ }
</script>
</body>
</html>
